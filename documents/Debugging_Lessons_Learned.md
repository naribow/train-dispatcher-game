# デバッグで学んだ教訓

このドキュメントは、「トレイン・ディスパッチャー：ステーション・フロー」の開発初期段階で遭遇した主要な問題点と、それらを解決する過程で得られた教訓をまとめたものです。今後の開発において、同様のミスを避け、効率的なデバッグを行うための指針とします。

## 1. CI/CDセットアップに関する問題

### 1.1. ESLint v9の設定変更
- **問題**: ESLint v9から設定ファイルの形式が`.eslintrc.json`から`eslint.config.js`（ES Modules形式）に変更されたため、CIでLintが失敗した。
- **教訓**: 主要なライブラリのメジャーバージョンアップ時には、公式のマイグレーションガイドを必ず確認し、設定ファイルの変更点に注意する。特にCI/CDパイプラインに影響する変更は早期に検知する。

### 1.2. 依存関係の不足 (`typescript-eslint`)
- **問題**: `eslint.config.js`で`typescript-eslint`をインポートしているにも関わらず、`package.json`に`typescript-eslint`パッケージが直接追加されていなかったため、CIでモジュールが見つからないエラーが発生した。
- **教訓**: 新しいライブラリやフレームワークを導入する際は、そのライブラリが依存するすべてのパッケージが正しくインストールされているかを確認する。特に、設定ファイルでインポートされるモジュールは注意深く確認する。

### 1.3. GitHub Actionsのバージョン管理と権限
- **問題**: `actions/upload-pages-artifact`や`actions/deploy-pages`などのGitHub Actionsのバージョンが古く、非推奨になったためにデプロイが失敗した。また、`stefanzweifel/git-auto-commit-action`がコードの自動フォーマット後にコミット・プッシュする際に、`contents: write`や`workflows: write`の権限が不足していた。
- **教訓**: 
  - GitHub Actionsのアクションは定期的に最新バージョンを確認し、非推奨の警告が出た場合は速やかに更新する。
  - 自動コミットやワークフローファイルの変更を伴うアクションを使用する場合、必要な権限（`contents: write`, `workflows: write`など）をジョブレベルで明示的に付与する。

### 1.4. `github.head_ref`と`github.ref`の使い分け
- **問題**: `actions/checkout`で`ref: ${{ github.head_ref }}`を使用していたため、`push`イベントで`github.head_ref`が空になり、チェックアウトに失敗した。また、`git-auto-commit-action`が`pull_request`イベントでのみ動作するように条件を付けたが、`push`イベントと`pull_request`イベントで`actions/checkout`の`ref`の扱いが異なるため、一つのワークフローで両方に対応するのが困難だった。
- **教訓**: 
  - `push`イベントでは`github.ref`を、`pull_request`イベントでは`github.head_ref`を使用するなど、イベントタイプに応じて適切なコンテキスト変数を使用する。
  - 複雑なCI/CDロジックは、イベントタイプごとにワークフローファイルを分離することで、可読性と保守性を高める。

## 2. PixiJS v8移行に関する問題

### 2.1. `Application`の初期化方法の変更
- **問題**: PixiJS v8で`Application`のコンストラクタオプションが非推奨となり、`init()`メソッドでオプションを渡す形式に変更された。また、`await app.init()`の呼び出しが必須になった。
- **教訓**: 
  - ライブラリのメジャーバージョンアップ時には、初期化方法や主要APIの変更点を特に注意して確認する。
  - 非同期処理（`async/await`）が導入された場合は、呼び出し元で適切に`await`を使用する。

### 2.2. `Graphics`描画メソッドの変更と描画順序
- **問題**: `Graphics#beginFill`、`Graphics#endFill`、`Graphics#drawRect`、`Graphics#lineStyle`が非推奨となり、それぞれ`fill`、`rect`、`stroke`に置き換えられた。また、`rect()`などの形状定義メソッドを`fill()`や`stroke()`の**前に**呼び出す必要がある。
- **教訓**: 
  - 非推奨警告は無視せず、速やかに新しいAPIに移行する。
  - 描画ライブラリのAPI変更は、描画順序やメソッドのチェーンの仕方に影響を与えることがあるため、公式ドキュメントのサンプルコードを参考に、正しい使用方法を再確認する。

### 2.3. レンダリングループの明示的な開始
- **問題**: PixiJS v8では`app.start()`を明示的に呼び出してレンダリングループを開始する必要がある。これを怠ると、描画コマンドが実行されても画面が更新されない。
- **教訓**: 
  - ライブラリの内部動作（レンダリングループの開始など）が変更された場合、その変更点を把握し、必要な初期化ステップを漏れなく実行する。

## 3. デバッグと問題解決の教訓

### 3.1. 段階的な開発と最小構成での確認
- **教訓**: 複雑な機能を追加する前に、常に最小限の機能（例: 青い背景に赤い四角形）で動作確認を行う。問題が発生した場合は、可能な限り問題を切り分け、最小構成で再現・解決を試みる。

### 3.2. 詳細なログ出力
- **教訓**: 問題の切り分けが難しい場合や、見た目に変化がない場合は、コードの各所で詳細なログ（`console.log`）を出力し、プログラムの実行フローや変数の状態を確認する。特に、初期化の成功/失敗、描画メソッドの呼び出し、描画対象のプロパティ（位置、サイズ、子要素など）は重点的にログ出力する。

### 3.3. ブラウザ開発者ツールの活用
- **教訓**: コンソールエラーだけでなく、要素のインスペクターでCanvas要素がDOMに正しく追加されているか、スタイルが適用されているか、サイズが適切かなどを確認する。ネットワークタブでリソースのロードエラーがないかも確認する。

### 3.4. 表示されない要素のデバッグ
- **問題**: ログ上は描画されているはずの要素が画面に表示されない。
- **原因**: 
  - **描画順序の誤り**: `Graphics`オブジェクトの`rect()`や`circle()`などの形状定義メソッドを`fill()`や`stroke()`などのスタイル設定メソッドの**前に**呼び出す必要がある。
  - **座標の問題**: 要素がCanvasの可視範囲外に描画されている、またはサイズが小さすぎる。
  - **色の問題**: 要素の色が背景色と似ているため、視認できない。
  - **レンダリングループの問題**: `app.start()`が呼び出されていない、またはゲームループ内で`app.render()`が適切に呼び出されていない。
- **教訓**: 
  - 描画順序を厳密に守る。
  - デバッグ時には、画面全体を覆うような非常に目立つ色の大きな図形を描画し、描画自体が機能しているかを確認する。
  - 座標やサイズをログに出力し、想定通りの値になっているかを確認する。

### 3.5. 画面レイアウトとスクロールの問題
- **問題**: HTML要素（タイトルなど）がPixiJSのCanvas描画領域を阻害し、意図しないスクロールが発生する。
- **教訓**: 
  - PixiJSのCanvasを画面全体に表示する場合、`body`や`html`、Canvasを格納するコンテナ要素のCSSで`margin: 0; overflow: hidden;`や`width: 100vw; height: 100vh;`を設定し、余白やスクロールをなくす。
  - HTML要素とCanvas要素のレイアウトを明確に分離し、互いに干渉しないように設計する。

これらの教訓を活かし、今後の開発をよりスムーズに進めていきます。